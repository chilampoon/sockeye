import pathlib
import os
import pandas as pd
from glob import glob
from itertools import product
from snakemake.utils import validate, min_version


##### load config and sample sheets #####
configfile: "config/config.yml"


SCRIPT_DIR = srcdir("scripts")
sample_sheet = pd.read_csv(config["runs"], sep=",", comment="#").set_index(
    "run_id", drop=True
)

##### set filenames #####
OUTPUT_BASE = pathlib.Path(config["OUTPUT_BASE"])


##### read values from sample sheet ####
RUN_IDS = sample_sheet.index


###################
# READ ADAPTER SCAN FILES
###################
COPIED_DIR = OUTPUT_BASE / "{run_id}" / "ingest"
COPIED_FILES = str(COPIED_DIR / "{batch_id}.fastq.gz")
ADAPTERS_DIR = OUTPUT_BASE / "{run_id}" / "adapters"
READ_CONFIG_CHUNKED = str(ADAPTERS_DIR / "{batch_id}.configs.tsv")
STRANDED_FQ_CHUNKED = str(ADAPTERS_DIR / "{batch_id}.stranded.fastq")
READ_CONFIG = str(ADAPTERS_DIR / "configs.tsv")
STRANDED_FQ = str(ADAPTERS_DIR / "reads.stranded.fastq")
CONFIG_STATS = str(ADAPTERS_DIR / "configs.stats.json")


###################
# BARCODE DEMUX FILES
###################
DEMUX_DIR = OUTPUT_BASE / "{run_id}" / "barcodes"
BARCODES = str(DEMUX_DIR / "uncorr.fasta")
BARCODES_HQ = str(DEMUX_DIR / "uncorr.hq.fasta")
BARCODES_CLUSTERS = str(DEMUX_DIR / "clusters.fasta")
BARCODES_WHITELIST = str(DEMUX_DIR / "whitelist.tsv")
BARCODES_KNEEPLOT = str(DEMUX_DIR / "kneeplot.png")
BARCODES_ASSIGNS = str(DEMUX_DIR / "assigns.tsv")
BARCODES_ASSIGNS_FILTERED = str(DEMUX_DIR / "assigns.filtered.tsv")
BARCODES_ASSIGNS_FILTERED_COUNTS = str(DEMUX_DIR / "assigns.filtered.counts.tsv")


###################
# UMI DEMUX FILES
###################
UMI_DIR = OUTPUT_BASE / "{run_id}" / "umis"
UMI_EXTRACTED_READS = str(UMI_DIR / "reads.bc.umi.fastq")


###################
# REF ALIGN FILES
###################
REF_GENES_GTF = pathlib.Path(config["REF_GTF"])
REF_GENES_DIR = REF_GENES_GTF.parents[0]
REF_GENES_BED = str(REF_GENES_DIR / f'{REF_GENES_GTF.name.replace(".gtf", ".bed")}')
ALIGN_DIR = OUTPUT_BASE / "{run_id}" / "align"
REF_CHROM_SIZES = str(ALIGN_DIR / "chrom_sizes.tsv")
SAM_TMP = str(ALIGN_DIR / "tmp.sam")
BAM_UNSORT_TMP = str(ALIGN_DIR / "tmp.unsort.bam")
BAM_SORT = str(ALIGN_DIR / "sorted.bam")


###################
# OUTPUT BAM FILES
###################
UMI_UNCORR_TAGGED_BAM = str(UMI_DIR / "umi_uncorr.sorted.bam")
UMI_UNCORR_TAGGED_BAM_BAI = str(UMI_DIR / "umi_uncorr.sorted.bam.bai")
TAGGED_BAM = str(UMI_DIR / "tagged.sorted.bam")
TAGGED_BAM_BAI = str(UMI_DIR / "tagged.sorted.bam.bai")


###################
# FEATURECOUNTS FILES
###################
FC_DIR = OUTPUT_BASE / "{run_id}" / "features"
FC_READ_ASSIGNS_TMP = str(FC_DIR / "sorted.bam.featureCounts")
FC_READ_ASSIGNS = str(FC_DIR / "read.gene_assigns.tsv")
FC_GENES = str(FC_DIR / "gene_assigned")
FC_SUMMARY = str(FC_DIR / "gene_assigned.summary")


##### include rules #####
include: "rules/stranding.smk"
include: "rules/barcodes.smk"
include: "rules/umis.smk"
include: "rules/align.smk"
include: "rules/features.smk"


##### target rules #####
rule all:
    input:
        expand(READ_CONFIG, run_id=RUN_IDS),
        expand(STRANDED_FQ, run_id=RUN_IDS),
        expand(CONFIG_STATS, run_id=RUN_IDS),
        expand(BARCODES_ASSIGNS_FILTERED_COUNTS, run_id=RUN_IDS),
        expand(BAM_SORT, run_id=RUN_IDS),
        expand(FC_SUMMARY, run_id=RUN_IDS),
        expand(TAGGED_BAM, run_id=RUN_IDS),
